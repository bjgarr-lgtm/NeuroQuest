<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NeuroQuest • Godot Build</title>

  <!-- Fonts / basic styles -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="icon" href="assets/neuroquest-shield.svg" type="image/svg+xml"/>

  <style>
    :root{
      --bg:#0b0b12; --panel:#141429; --ink:#cfe6ff;
      --z-game: 10; --z-hud: 80; --z-drawer: 90; --z-nyx: 120;
      --header-h: 64px; --drawer-w: 300px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:'Press Start 2P', system-ui, sans-serif}

    /* Header HUD (optional) */
    .app-header{position:sticky; top:0; z-index:var(--z-hud);
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.2));
      backdrop-filter: blur(6px);
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--ink)}
    .logo{width:48px;height:48px;filter:drop-shadow(0 0 6px #7cf)}

    /* Godot canvas container */
    #godot-root{
      position:fixed; inset:0;
      z-index:var(--z-game);
      background:#000;
      pointer-events:auto;  /* game is interactive */
    }

    /* Right-side drawer (overlay) */
    #drawer{
      position:fixed; top:var(--header-h); right:-var(--drawer-w); bottom:0; width:var(--drawer-w);
      background:rgba(10,10,22,.98); border-left:1px solid #444; padding:12px; z-index:var(--z-drawer);
      transition: transform .22s ease-out; transform: translateX(0); /* moved via 'right' */
    }
    #drawer.open{ right:0; }
    #scrim{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition:opacity .2s; z-index:calc(var(--z-drawer) - 1);
    }
    #drawer.open + #scrim{ opacity:1; pointer-events:auto; }

    /* NYX floaters always on top (optional) */
    #nyx-launcher, #nyx-panel{ position:fixed; right:16px; z-index:var(--z-nyx); }
    #nyx-launcher{ bottom:16px; }
    #nyx-panel{ bottom:76px; max-height:calc(100dvh - 120px); }

    /* Minimal HUD bits */
    .hud{display:flex; gap:12px; align-items:center}
    .hamb{border:1px solid #555; background:#111; color:#9fe; border-radius:10px; padding:6px 10px; cursor:pointer}
  </style>
</head>
<body>

  <!-- Tiny HUD (optional) -->
  <header class="app-header">
    <a class="brand" href="#">
      <img src="assets/neuroquest-shield.svg" class="logo" alt="NeuroQuest"/>
      <span>NeuroQuest</span>
    </a>
    <div class="hud">
      <button id="hamb" class="hamb" title="Menu">☰</button>
    </div>
  </header>

  <!-- Godot mounts here -->
  <div id="godot-root"></div>

  <!-- Overlay drawer on the RIGHT -->
  <aside id="drawer"><nav id="nav">
    <!-- put any web overlays (settings, quit, etc.) here, or leave empty -->
  </nav></aside>
  <div id="scrim"></div>

  <script>
  // ---------- CONFIG: where your game is hosted ----------
  // Your Worker serves: https://nq-game-worker.bjgarr.workers.dev/
  // Files are: nq.js, nq.wasm, nq.pck, etc. at the ROOT.
  const GODOT_BASE = "https://nq-game-worker.bjgarr.workers.dev";
  const GODOT_EXECUTABLE = GODOT_BASE + "/nq";  // base name for nq.{js,wasm,pck}

  // ---------- Drawer toggle (right-side) ----------
  (function(){
    const drawer = document.getElementById('drawer');
    const scrim  = document.getElementById('scrim');
    const hamb   = document.getElementById('hamb');
    if (!drawer || !scrim || !hamb) return;
    const open  = () => drawer.classList.add('open');
    const close = () => drawer.classList.remove('open');
    const toggle= () => drawer.classList.toggle('open');
    hamb.addEventListener('click', toggle);
    scrim.addEventListener('click', close);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
  })();

  // ---------- Page ↔ Game bridge ----------
  // PAGE → GAME: call globalThis.NQ_toGame({...})
  // GAME → PAGE: listen for 'nq:fromGame' CustomEvent
  (function bridge(){
    // Listen to messages sent by Godot
    window.addEventListener('nq:fromGame', (e)=>{
      const data = e?.detail;
      console.log('[fromGame]', data);
      // Example: hook to your NYX tracker if you want web-side rewards
      try { window.NQ_track?.(data?.type||'fromGame', data||{}); } catch(_){}
    });
    // Simple demo button in console:
    //   NQ_toGame?.({type:'quest:complete', id:'q_demo'})
  })();

  // ---------- Boot Godot ----------
  (function bootGodot(){
    const root = document.getElementById('godot-root');

    // load nq.js from the Worker
    const s = document.createElement('script');
    s.src = GODOT_BASE + '/nq.js';
    s.async = true;
    s.onerror = () => console.error('[Godot] failed to load loader script', s.src);
    s.onload = () => {
      const cfg = {
        // Godot 4.3/4.4 loaders accept one of these shapes depending on template
        executable: GODOT_EXECUTABLE,         // base for nq.wasm / nq.pck
        canvasContainer: root,                 // create canvas inside
        focusCanvas: true,
        // try to keep audio working if your Worker sends COOP/COEP headers
        // (Cross-Origin-Opener-Policy: same-origin, Cross-Origin-Embedder-Policy: require-corp)
      };

      // Support both loader flavors
      if (typeof Engine !== 'undefined') {
        const engine = new Engine(cfg);
        engine.startGame().then(()=>{
          console.log('[Godot] started (Engine)');
        }).catch(err=>{
          console.error('[Godot] start error', err);
        });
      } else if (typeof createEngine !== 'undefined') {
        createEngine(cfg).then(()=>{
          console.log('[Godot] started (createEngine)');
        }).catch(err=>{
          console.error('[Godot] start error', err);
        });
      } else {
        console.error('[Godot] Neither Engine nor createEngine found on window.');
      }
    };
    document.body.appendChild(s);
  })();

  // ---------- Minimal tracker shim so existing calls don’t explode ----------
  (function(){
    window.NQ_track = window.NQ_track || function (ev, payload) {
      try { if (window.NQ && typeof window.NQ.track === 'function') window.NQ.track(ev, payload||{}); } catch (e) {}
    };
    window.tracker = window.NQ_track;
  })();
  </script>

  <!-- (Optional) NYX — leave these if you still want the assistant overlay -->
  <script>window.NYX_LLM_ENDPOINT="https://nyx-llm-proxy.bjgarr.workers.dev";</script>
  <script type="module" src="js/bot/nyx.js?v=syntaxfix2"></script>
  <script type="module" src="js/bot/nyx-wire.js"></script>

</body>
</html>
