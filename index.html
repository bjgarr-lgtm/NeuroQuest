<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Cross-origin isolation (safe to include; needed if your export uses threads). -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">

  <title>NeuroQuest â€” Godot</title>

  <!-- Minimal CSS: Godot owns the screen. NYX floats above. -->
  <style>
    :root { --header-h: 64px; }
    html, body { height: 100%; margin: 0; background: #0b0b12; color: #cfe6ff; font-family: 'Press Start 2P', system-ui, sans-serif; }
    .app-header{position:sticky; top:0; z-index:900; display:flex; align-items:center; justify-content:space-between;
      padding:8px 12px; background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,.2)); backdrop-filter: blur(6px);}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:42px; height:42px; filter:drop-shadow(0 0 6px #7cf)}
    #godot-root{position:fixed; inset:0; z-index:100; background:#0b0b12; pointer-events:auto;}
    /* Hide the old planner UI; Godot is the full experience now */
    main.view, aside.drawer, .app-footer { display:none !important; }

    /* NYX on top */
    #nyx-panel, #nyx-launcher { z-index: 2000; position: fixed; right: 16px; }
    #nyx-launcher { bottom: 16px; }
    #nyx-panel { bottom: 76px; max-height: calc(100dvh - 120px); }
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <link rel="icon" href="assets/neuroquest-shield.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Minimal HUD header (optional; keep if you like the top bar) -->
  <header class="app-header">
    <a class="brand" id="brand" href="#home">
      <img src="assets/neuroquest-shield.svg" class="logo" alt="NeuroQuest logo"/>
      <h1 style="font-size:16px; margin:0">NeuroQuest</h1>
    </a>
    <div class="hud" id="hud" style="display:flex; align-items:center; gap:12px">
      <div class="gold" id="hudGold">ðŸª™ 0</div>
      <span id="hudLevel">Lv 1</span>
      <div style="width:160px; height:8px; border:1px solid #6cf; border-radius:6px; overflow:hidden">
        <div id="hudXp" style="height:100%; width:0%; background:linear-gradient(90deg,#7cf,#e7a7ff)"></div>
      </div>
      <button id="musicBtn" class="hamb" title="Play/Pause music">â™ª</button>
      <audio id="music" preload="none"></audio>
    </div>
  </header>

  <!-- Godot mounts here (full screen) -->
  <div id="godot-root"></div>

<!-- Godot HTML5 boot -->
<div id="godot-root"></div>
<script>
(async function bootGodot(){
  const ROOT = document.getElementById('godot-root');
  Object.assign(ROOT.style, {
    position:'fixed', inset:'0', background:'#0b0b12',
    zIndex: 10, pointerEvents:'auto'
  });

  const BASE = 'https://nq-game-worker.bjgarr.workers.dev/game'; // <-- your Worker origin
  const files = ['nq.js','nq.wasm','nq.pck'];

  // Preflight check so errors are obvious
  try{
    const head = HEAD ? 'HEAD' : 'GET'; // some hosts donâ€™t allow HEAD
    const reqs = await Promise.allSettled(
      files.map(f => fetch(`${BASE}/${f}`, {method:'GET', cache:'no-store'}))
    );
    const bad = reqs.find(r => r.status !== 'fulfilled' || !r.value.ok);
    if(bad){
      console.error('[Godot] preflight failed', reqs);
      throw new Error('Preflight failed â€“ check Worker path/CORS/filenames.');
    }
  }catch(e){
    console.error('[Godot] preflight error:', e);
    return;
  }

  // Load the Godot loader script
  const s = document.createElement('script');
  s.src = `${BASE}/nq.wasm`;
  s.async = true;
  s.onerror = () => console.error('[Godot] failed to load loader script', s.src);
  s.onload = () => {
    if (typeof createEngine !== 'function') {
      console.error('[Godot] createEngine() not found. Is this the real Godot nq.wasm?');
      return;
    }
    // Start engine
    createEngine({
      canvasContainer: ROOT,
      executable: `${BASE}/nq`,   // base path (no extension) for .wasm/.pck
      focusCanvas: true,
      onProgress: (p)=>console.log('[Godot] load', Math.floor(p*100)+'%')
    }).then(() => {
      console.log('[Godot] started');
      // Bridge: PAGE â†’ GAME calls will be available to WebBridge.gd
      globalThis.NQ_toGame?.({ type:'ping', from:'web' });
    }).catch(err => {
      console.error('[Godot] start error', err);
    });
  };
  document.body.appendChild(s);

  // Keep NYX above the game
  const z = document.createElement('style');
  z.textContent = `
    #nyx-launcher, #nyx-panel { z-index: 2000; }
    .app-header { z-index: 90; position: sticky; top: 0; }
    #godot-root { z-index: 10; }
  `;
  document.head.appendChild(z);
})();
</script>

<!-- ============ PAGE â†” GODOT BRIDGE (JS side) ============ -->
  <script>
    // PAGE â†’ GAME: call this anywhere in your site to send messages to Godot
    window.NQ_toGame = (payload) => {
      try {
        // Godot sets this to a JS callback at runtime via WebBridge.gd
        if (typeof window.__NQ_toGame === 'function') {
          window.__NQ_toGame(payload);
        } else {
          // Not wired yet? queue it.
          (window.__NQ_queue ||= []).push(payload);
        }
      } catch(e){ console.warn('NQ_toGame error', e); }
    };

    // GAME â†’ PAGE: Godot will dispatch this CustomEvent (see WebBridge.gd)
    window.addEventListener('nq:fromGame', (e)=>{
      const data = e.detail;
      // Handle game events here:
      // e.g., quest complete, xp/gold updates, etc.
      if (data?.type === 'hud:update') {
        if (typeof data.gold === 'number') document.getElementById('hudGold').textContent = `ðŸª™ ${data.gold}`;
        if (typeof data.level === 'number') document.getElementById('hudLevel').textContent = `Lv ${data.level}`;
        if (typeof data.xpPct === 'number') document.getElementById('hudXp').style.width = `${Math.max(0,Math.min(100,data.xpPct))}%`;
      }
      // For debugging:
      // console.log('[fromGame]', data);
    });
  </script>

  <!-- ============ NYX (unchanged) ============ -->
  <script>window.NQ_track = window.NQ_track || function(ev,p){try{if(window.NQ?.track) window.NQ.track(ev,p||{});}catch(e){}}; window.tracker = window.NQ_track;</script>
  <script>window.NYX_LLM_ENDPOINT="https://nyx-llm-proxy.bjgarr.workers.dev";</script>
  <script type="module" src="js/bot/nyx.js?v=syntaxfix2"></script>
  <script type="module" src="js/bot/nyx-wire.js"></script>

</body>
</html>
