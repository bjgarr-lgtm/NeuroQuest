<!doctype html>
<html lang="en" class="theme-retro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SootheBirb — Finch Mode</title>
  <link rel="icon" href="assets/icon.svg" type="image/svg+xml"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* minimal helpers so we don't depend on styles.css changes */
    .hidden{display:none!important}
    .pet-shop{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:10px}
    .pet-card{border:1px solid #6cf;border-radius:12px;padding:10px;background:rgba(50,50,80,.35)}
    .pet-card h4{margin:0 0 6px 0;font-size:0.9rem}
    .pet-stage{min-height:180px;display:flex;align-items:flex-end;gap:12px}
    .birb{width:120px;image-rendering:auto;filter:none}
    .coins{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:10px;background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.35)}
    .coins b{font-weight:700}
    .calendar .embed-wrap{position:relative;width:100%;max-width:1100px;min-height:70vh}
    .calendar .embed-wrap iframe{position:absolute;inset:0;width:100%;height:100%}
    .calendar #weekGrid{display:none}
    .games-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:8px}
    .games-grid .card{padding:14px;border:1px solid #6cf;border-radius:14px;background:rgba(50,50,80,.35);cursor:pointer;text-align:center}
    .game-host{margin-top:16px}
    .game-box{position:relative;border:1px solid #999;border-radius:16px;background:rgba(20,20,30,.6);width:100%;max-width:680px;min-height:360px;margin:0 auto;padding:12px;overflow:hidden}
    .pop-bubble{position:absolute;width:48px;height:48px;border-radius:50%;background:radial-gradient(#9ff,#37a);box-shadow:0 0 10px #8ef;cursor:pointer}
    .balloon{position:absolute;width:42px;height:56px;border-radius:50% 50% 50% 50%/60% 60% 40% 40%;background:#f77;left:50%;transform:translateX(-50%);}
    .basket{position:absolute;bottom:8px;left:50%;width:90px;height:16px;background:#964B00;border-radius:8px;transform:translateX(-50%)}
    .simon{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:420px;margin:0 auto}
    .pad{height:120px;border-radius:12px;opacity:.8;cursor:pointer}
    .pad.red{background:#f44}.pad.blue{background:#46f}.pad.green{background:#2d6}.pad.yellow{background:#dd3}
    .pad.on{box-shadow:0 0 20px 6px rgba(255,255,255,.6);opacity:1}
  </style>
</head>
<script defer src="assets/hotfix-core.js"></script>
<script defer src="assets/hotfix-toddler-pet.js"></script>
<script defer src="assets/hotfix-fx.js"></script>
<body class="pixel crt">
  <header class="app-header">
    <div class="brand">
      <img src="assets/icon.svg" alt="" class="logo"/>
      <h1>SootheBirb</h1>
    </div>
    <nav class="top-nav" aria-label="Primary">
      <div id="navHighlighter" class="nav-hi"></div>
      <button data-route="home" class="nav-btn">Dashboard</button>
      <button data-route="tasks" class="nav-btn">Quests</button>
      <button data-route="clean" class="nav-btn">Cleaning</button>
      <button data-route="coop" class="nav-btn">Co‑Op</button>
      <button data-route="budget" class="nav-btn">Budget</button>
      <button data-route="meals" class="nav-btn">Meals</button>
      <button data-route="calendar" class="nav-btn">Calendar</button>
      <button data-route="shop" class="nav-btn">Shopping</button>
      <button data-route="characters" class="nav-btn">Character</button>
      <button data-route="companion" class="nav-btn">Companion</button>
      <button data-route="pet" class="nav-btn">Toddler Pet</button>
      <button data-route="breathe" class="nav-btn">Breathe</button>
      <button data-route="minigames" class="nav-btn">Minigames</button>
      <button data-route="journal" class="nav-btn">Journal</button>
      <button data-route="checkin" class="nav-btn">Check‑In</button>
      <button data-route="rewards" class="nav-btn">Rewards</button>
      <button data-route="settings" class="nav-btn">Settings</button>
    </nav>
    <button id="musicBtn" class="music-toggle" title="Music">♪</button>
    <div id="hudStrip" class="hud small">
      <div class="avatars" id="hudAvatars"></div>
      <div class="hearts" id="hudHearts"></div>
      <div class="gold" id="hudGold">🪙 0</div>
      <div class="xp-wrap">
        <div class="xp-label"><span id="hudLevel">Lv 1</span><span class="flame">🔥</span></div>
        <div class="xp-bar"><div id="hudXp"></div></div>
      </div>
    </div>
  </header>

  <main id="view" class="view"></main>
  <div id="fxLayer" class="fx-layer" aria-hidden="true"></div>

  <footer class="app-footer">
    <span id="streakLabel">Streak: 0 🔥 | Best: 0</span>
    <span class="dot">•</span>
    <button id="exportBtn" class="secondary">Export</button>
    <input type="file" id="importFile" accept="application/json" style="display:none"/>
    <button id="importBtn" class="secondary">Import</button>
  </footer>

  <!-- Character Select -->
  <template id="tpl-characters">
    <section class="cardish">
      <h2 class="dash">Choose Your Hero</h2>
      <div class="char-grid" id="charGrid"></div>
      <div class="row">
        <button id="uploadChar" class="secondary">Upload custom art</button>
        <input id="charFile" type="file" accept="image/*" style="display:none"/>
      </div>
    </section>
  </template>

  <!-- Companion Select -->
  <template id="tpl-companion">
    <section class="cardish">
      <h2 class="dash">Choose Your Companion</h2>
      <div class="comp-grid" id="compGrid"></div>
    </section>
  </template>

  <!-- Home -->
  <template id="tpl-home">
    <section class="dash-board">
      <div class="party-banner">
        <div class="party-label">Your Party</div>
        <div class="party-members" id="partyBanner"></div>
      </div>
      <div class="xp-slab">
        <div class="xp-title">XP</div>
        <div class="xp-bar big"><div id="xpBig"></div></div>
        <div class="xp-meta"><span id="xpBigLabel">Lv 1</span></div>
      </div>
      <div class="tile-grid">
        <a class="tile" data-route="tasks"><div class="tile-label">Daily Planner</div></a>
        <a class="tile" data-route="rewards"><div class="tile-label">Rewards</div></a>
        <a class="tile" data-route="clean"><div class="tile-label">Cleaning</div></a>
        <a class="tile" data-route="coop"><div class="tile-label">Co‑Op</div></a>
        <a class="tile" data-route="calendar"><div class="tile-label">Calendar</div></a>
        <a class="tile" data-route="shop"><div class="tile-label">Shopping</div></a>
        <a class="tile" data-route="budget"><div class="tile-label">Budget</div></a>
        <a class="tile" data-route="meals"><div class="tile-label">Meals</div></a>
        <a class="tile" data-route="characters"><div class="tile-label">Character</div></a>
        <a class="tile" data-route="companion"><div class="tile-label">Companion</div></a>
        <a class="tile" data-route="pet"><div class="tile-label">Toddler Pet</div></a>
        <a class="tile" data-route="minigames"><div class="tile-label">Minigames</div></a>
      </div>
    </section>
  </template>

  <!-- Tasks -->
  <template id="tpl-tasks">
    <section class="quest-board">
      <h2 class="dash">Daily Quest Board</h2>
      <div class="panels">
        <div class="panel panel-red">
          <div class="panel-title">Main Quest</div>
          <div id="panelMain" class="panel-list"></div>
        </div>
        <div class="panel panel-green">
          <div class="panel-title">Side Quests</div>
          <div id="panelSide" class="panel-list"></div>
        </div>
        <div class="panel panel-purple">
          <div class="panel-title">Bonus Loot</div>
          <div id="panelBonus" class="panel-list"></div>
        </div>
      </div>
      <div class="panel add-panel">
        <div class="row">
          <input id="newTaskTitle" placeholder="Add a quest…"/>
          <select id="newTaskTier">
            <option value="main">Main</option>
            <option value="side">Side</option>
            <option value="bonus">Bonus</option>
          </select>
          <button id="addTaskBtn" class="primary">Add</button>
        </div>
      </div>
    </section>
  </template>

  <!-- Cleaning -->
  <template id="tpl-clean">
    <section class="quest-board">
      <h2 class="dash">Cleaning Dungeon</h2>
      <div class="panels">
        <div class="panel panel-purple">
          <div class="panel-title">Small Quests</div>
          <div id="cleanSmall" class="panel-list"></div>
        </div>
        <div class="panel panel-blue">
          <div class="panel-title">Weekly Boss</div>
          <div class="boss">
            <div class="row"><span>Progress</span><div class="xp-bar"><div id="bossProg"></div></div></div>
            <div id="bossList" class="list"></div>
            <div class="row"><input id="bossName" placeholder="Name this boss…"/><button id="bossNew" class="primary">Set</button><button id="bossTick" class="secondary">+10%</button></div>
          </div>
        </div>
        <div class="panel panel-cyan">
          <div class="panel-title">Monthly Raid</div>
          <div id="raidInfo" class="list"></div>
        </div>
      </div>
      <div class="panel add-panel">
        <div class="row">
          <input id="newCleanTask" placeholder="Add a cleaning quest…"/>
          <button id="addCleanTask" class="primary">Add</button>
        </div>
      </div>
    </section>
  </template>

  <!-- Co‑Op -->
  <template id="tpl-coop">
    <section class="quest-board">
      <h2 class="dash">Co‑Op Mode <small id="coopWeek" class="tag">Solo Week</small></h2>
      <div class="panels">
        <div class="panel panel-green">
          <div class="panel-title">Sidekick Quests</div>
          <div id="sidekickList" class="panel-list"></div>
        </div>
        <div class="panel panel-orange">
          <div class="panel-title">Collectibles</div>
          <div id="coopCollect" class="panel-list"></div>
        </div>
      </div>
      <div class="panel add-panel">
        <div class="row">
          <input id="newSidekick" placeholder="Add a sidekick quest…"/>
          <button id="addSidekick" class="primary">Add</button>
          <button id="toggleWeek" class="secondary">Toggle Week</button>
        </div>
      </div>
    </section>
  </template>

  <!-- Budget -->
  <template id="tpl-budget">
    <section class="budget">
      <h2 class="dash">Budget Tracker</h2>
      <div class="grid2">
        <div class="stat cardish"><div class="k">Gold Pouch</div><div id="goldPouch" class="v">$0</div></div>
        <div class="stat cardish"><div class="k">This Week's Spend</div><div id="thisSpend" class="v">$0</div></div>
      </div>
      <div class="goal cardish">
        <div class="k">Budget Goal</div>
        <div class="xp-bar"><div id="budgetBar"></div></div>
      </div>
      <section class="cardish">
        <h3>Recent Transactions</h3>
        <div id="txnList" class="list"></div>
      </section>
      <div class="grid2">
        <div class="cardish">
          <h3>New Income</h3>
          <div class="row"><input id="incLabel" placeholder="Label"/><input id="incAmt" type="number" placeholder="Amount"/></div>
          <button id="addIncome" class="primary">+ Add Income</button>
        </div>
        <div class="cardish">
          <h3>New Expense</h3>
          <div class="row"><input id="expLabel" placeholder="Label"/><input id="expAmt" type="number" placeholder="Amount"/></div>
          <button id="addExpense" class="danger">− Add Expense</button>
        </div>
      </div>
    </section>
  </template>

  <!-- Meals -->
  <template id="tpl-meals">
    <section class="meals">
      <h2 class="dash">Meal Planner</h2>
      <div id="mealGrid" class="meal-grid"></div>
    </section>
  </template>

  <!-- Calendar -->
  <template id="tpl-calendar">
    <section class="calendar">
      <h2 class="dash">Weekly Calendar</h2>
      <div class="week-grid" id="weekGrid"></div>
      <div class="embed-wrap"><iframe id="gcalFrame" src="" frameborder="0" scrolling="no"></iframe></div>
    </section>
  </template>

  <!-- Shop -->
  <template id="tpl-shop">
    <section class="shop">
      <h2 class="dash">Shopping List</h2>
      <div id="shopList" class="panel-list"></div>
      <div class="row"><input id="shopItem" placeholder="Add item…"/><button id="addShop" class="primary">Add</button></div>
    </section>
  </template>

  <!-- Rewards -->
  <template id="tpl-rewards">
    <section class="rewards">
      <h2 class="dash">Collectibles & Achievements</h2>
      <div class="badges" id="badgeGrid"></div>
    </section>
  </template>

  <!-- Check-In -->
  <template id="tpl-checkin">
    <section class="cardish">
      <h2 class="dash">Mood Check‑In</h2>
      <div class="mood-row">
        <span class="mood" data-mood="awful">😖</span>
        <span class="mood" data-mood="bad">☹️</span>
        <span class="mood" data-mood="ok">😐</span>
        <span class="mood" data-mood="good">🙂</span>
        <span class="mood" data-mood="great">🤩</span>
      </div>
      <label class="field"><span>Tags</span><input id="checkinTags" placeholder="slept well, social…"/></label>
      <label class="field"><span>Notes</span><textarea id="checkinNotes" rows="4"></textarea></label>
      <button id="saveCheckin" class="primary">Save check‑in</button>
      <h3>Recent moods</h3>
      <div id="moodList" class="panel-list"></div>
    </section>
  </template>

  <!-- Journal -->
  <template id="tpl-journal">
    <section class="cardish">
      <h2 class="dash">Journal</h2>
      <label class="field"><span>Prompt</span><select id="journalPrompt"></select></label>
      <label class="field"><span>Entry</span><textarea id="journalText" rows="8" placeholder="Let it out…"></textarea></label>
      <div class="row"><button id="saveJournal" class="primary">Save</button><button id="newPrompt" class="secondary">New prompt</button></div>
      <div id="journalList" class="list"></div>
      <small id="journalStorage"></small>
    </section>
  </template>

  <!-- Pet (Toddler only UI) -->
  <template id="tpl-pet">
    <section class="cardish">
      <h2 id="petTitle" class="dash">Toddler Pet</h2>
      <div class="row" style="align-items:center;gap:10px">
        <span class="coins">🧒 Toddler Coins: <b id="todCoins">0</b></span>
        <button id="earnHint" class="secondary">How to earn?</button>
      </div>
      <div class="pet-stage" id="petStage"></div>
      <details open><summary>Accessories (owned)</summary><div class="grid two" id="accList"></div></details>
      <section class="pet-shop">
        <div class="pet-card"><h4>Cap</h4><div>Cost: 1</div><button data-buy="cap">Buy</button></div>
        <div class="pet-card"><h4>Bow</h4><div>Cost: 1</div><button data-buy="bow">Buy</button></div>
        <div class="pet-card"><h4>Glasses</h4><div>Cost: 2</div><button data-buy="glasses">Buy</button></div>
        <div class="pet-card"><h4>Scarf</h4><div>Cost: 2</div><button data-buy="scarf">Buy</button></div>
        <div class="pet-card"><h4>Boots</h4><div>Cost: 3</div><button data-buy="boots">Buy</button></div>
      </section>
      <p id="petNotice" class="hidden">Enable Toddler Mode in Settings to use the pet.</p>
    </section>
  </template>

  <!-- Breathe -->
  <template id="tpl-breathe">
    <section class="cardish">
      <h2 class="dash">1‑Minute Breathe</h2>
      <p>Tap the circle: inhale → hold → exhale → hold.</p>
      <div class="breathe-stage">
        <div class="circle" id="breathCircle" title="Start or stop breathing"></div>
        <div id="breathPhase" class="phase">Ready</div>
      </div>
    </section>
  </template>

  <!-- Minigames -->
  <template id="tpl-minigames">
    <section class="cardish">
      <h2 class="dash">Toddler Minigames</h2>
      <div id="gamesGrid" class="games-grid"></div>
      <div id="gameHost" class="game-host" aria-live="polite"></div>
    </section>
  </template>

  <!-- Settings -->
  <template id="tpl-settings">
    <section class="cardish">
      <h2 class="dash">Settings</h2>
      <label class="field"><span>Your name</span><input id="userName"/></label>
      <label class="field"><span>Theme</span>
        <select id="themeSelect">
          <option value="retro">Retro Neon</option>
          <option value="forest">Forest</option>
          <option value="dusk">Dusk</option>
          <option value="sunrise">Sunrise</option>
          <option value="ocean">Ocean</option>
          <option value="punk">Punk</option>
        </select>
      </label>
      <label class="field"><span>Typeface</span>
        <select id="fontSelect">
          <option value="press2p">Press Start 2P</option>
          <option value="system-ui">System</option>
          <option value="serif">Serif</option>
          <option value="mono">Mono</option>
        </select>
      </label>
      <label class="field"><span>Art Style</span>
        <select id="artSelect"><option value="pixel">Pixel</option><option value="classic">Classic</option></select>
      </label>
      <label class="field"><span>CRT Scanlines</span><input type="checkbox" id="scanlinesToggle" checked/></label>
      <label class="field"><span>Toddler Mode</span><input type="checkbox" id="toddlerToggle"/></label>
      <div class="row"><button id="saveSettings" class="primary">Save</button><button id="resetApp" class="danger">Reset app</button></div>
    </section>
  </template>

  <script type="module" src="app.js"></script>

  <!-- INLINE helpers: nav routing, calendar sanitizer, minigames, toddler pet/shop -->
  <script>
  (function(){
    const $V = ()=>document.querySelector('#view');
    const LS = { get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch(_){return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };
    const DEF = {toddler:false,toddlerCoins:0,pet:{acc:[],owned:[]},wardrobe:{owned:[],equipped:[]}};
    const S = LS.get('sb_state', DEF);

    // freebies (adult wardrobe)
    (function freebies(){
      if(!S.wardrobe) S.wardrobe={owned:[],equipped:[]};
      const own=S.wardrobe.owned||[]; ['copper-crown','torch','adventurer-cloak'].forEach(id=>{ if(!own.includes(id)) own.push(id) });
      S.wardrobe.owned=own; LS.set('sb_state',S);
    })();

    // global nav click
    document.addEventListener('click', e=>{
      const btn = e.target.closest('[data-route]');
      if(btn){ location.hash = '#'+btn.dataset.route; }
    });

    // route hooks
    function onRoute(){
      const r=(location.hash||'#home').slice(1);
      if(r==='calendar') ensureCalendar();
      if(r==='minigames') ensureGames();
      if(r==='pet') ensurePet();
    }
    window.addEventListener('hashchange', onRoute);
    document.addEventListener('DOMContentLoaded', onRoute);

    // Calendar sanitizer
    function cleanGcalInput(val){
      const def='https://calendar.google.com/calendar/embed?src=en.usa%23holiday%40group.v.calendar.google.com&ctz=America%2FLos_Angeles';
      if(!val) return def; val=String(val).trim();
      const m=val.match(/src=["']([^"']+)["']/i); if(m) val=m[1];
      val=val.replace(/^"|^'|"$|'$/g,'');
      if(val.startsWith('//')) val='https:'+val;
      if(!/^https?:/i.test(val)) val='https://'+val.replace(/^\/+/,'');
      try{ const u=new URL(val); if(!u.hostname.includes('calendar.google.com')) return def; return u.href; }catch(e){ return def; }
    }
    function ensureCalendar(){ const f=document.querySelector('#gcalFrame'); if(!f) return; const src=cleanGcalInput(LS.get('sb_gcal',null)); if(f.src!==src) f.src=src; }

    // Minigames hub
    function ensureGames(){
      const tpl=document.querySelector('#tpl-minigames'); const v=$V(); if(!tpl||!v) return;
      if(!document.querySelector('#gamesGrid')){ v.innerHTML=''; v.appendChild(tpl.content.cloneNode(true)); }
      const grid=document.querySelector('#gamesGrid'); const host=document.querySelector('#gameHost'); if(!grid||!host) return;
      grid.innerHTML='';
      const games=[
        {id:'pop',label:'Pop Bubbles'},{id:'colors',label:'Color Match'},
        {id:'float',label:'Balloon Float'},{id:'simon',label:'Simon Pads'},
        {id:'memory',label:'Mini Memory'},{id:'whack',label:'Whack-a-Slime'},
        {id:'catch',label:'Catch Stars'},{id:'shapes',label:'Shape Tap'}
      ];
      games.forEach(g=>{ const b=document.createElement('button'); b.className='card'; b.textContent=g.label; b.onclick=()=>startGame(g.id); grid.appendChild(b); });
      host.innerHTML='<p>Choose a game. Win rounds to earn toddler coins.</p>';
    }
    function awardCoins(n){ const s=LS.get('sb_state',DEF); s.toddlerCoins=(s.toddlerCoins||0)+n; LS.set('sb_state',s); const el=document.getElementById('todCoins'); if(el) el.textContent=s.toddlerCoins; }
    function startGame(id){
      const host=document.querySelector('#gameHost'); host.innerHTML=''; const box=document.createElement('div'); box.className='game-box'; host.appendChild(box);
      if(id==='pop'){ let score=0,time=20; const t=setInterval(()=>{ if(--time<=0){ clearInterval(t); clearInterval(sp); awardCoins(1+Math.floor(score/6)); box.innerHTML='<h3 style="text-align:center">Score '+score+'</h3>'; } },1000);
        const sp=setInterval(()=>{ const b=document.createElement('div'); b.className='pop-bubble'; b.style.left=Math.random()*(box.clientWidth-60)+'px'; b.style.top=Math.random()*(box.clientHeight-60)+'px'; b.onclick=()=>{score++; b.remove();}; box.appendChild(b); setTimeout(()=>b.remove(),2000); },520); }
      else if(id==='colors'){ const colors=['red','blue','green','yellow','purple','orange']; let rounds=8,score=0; const tgt=document.createElement('div'); tgt.style.textAlign='center'; tgt.style.margin='6px 0 12px'; box.appendChild(tgt);
        const row=document.createElement('div'); row.style.display='flex'; row.style.flexWrap='wrap'; row.style.gap='8px'; box.appendChild(row);
        function next(){ if(rounds--<=0){ awardCoins(Math.max(1,score)); box.innerHTML='<h3 style="text-align:center">Matches '+score+'</h3>'; return; }
          row.innerHTML=''; const want=colors[Math.floor(Math.random()*colors.length)]; tgt.innerHTML='Find: <b style="text-transform:capitalize">'+want+'</b>'; const answers=[...colors].sort(()=>Math.random()-.5).slice(0,5);
          answers.forEach(c=>{ const btn=document.createElement('button'); btn.textContent=c; btn.style.padding='10px 14px'; btn.style.borderRadius='10px'; btn.onclick=()=>{ if(c===want) score++; next(); }; row.appendChild(btn); }); }
        next(); }
      else if(id==='float'){ const balloon=document.createElement('div'); balloon.className='balloon'; balloon.style.top='50%'; box.appendChild(balloon); const basket=document.createElement('div'); basket.className='basket'; box.appendChild(basket);
        let y=box.clientHeight*0.5, vy=-0.02, thrust=0, score=0; const info=document.createElement('div'); info.style.position='absolute'; info.style.right='10px'; info.style.top='10px'; info.textContent='Hold mouse/touch to lift'; box.appendChild(info);
        function step(){ thrust*=0.9; vy+=0.0016-thrust; y+=vy; if(y<20){ y=20; vy*=-0.6; } if(y>box.clientHeight-80){ y=box.clientHeight-80; vy*=-0.6; } balloon.style.top=y+'px'; score++; if(score>1100){ cancelAnimationFrame(raf); awardCoins(2); box.innerHTML='<h3 style="text-align:center">Nice floating!</h3>'; return; } raf=requestAnimationFrame(step); }
        let raf=requestAnimationFrame(step); const on=()=>{thrust=0.02;}, off=()=>{thrust=0;}; box.addEventListener('mousedown',on); box.addEventListener('mouseup',off); box.addEventListener('touchstart',on,{passive:true}); box.addEventListener('touchend',off); }
      else if(id==='simon'){ const pads=['red','blue','green','yellow'].map(c=>{ const d=document.createElement('button'); d.className='pad '+c; return d; }); const wrap=document.createElement('div'); wrap.className='simon'; pads.forEach(p=>wrap.appendChild(p)); box.appendChild(wrap);
        let seq=[],input=[],level=1,active=false; function flash(p){ p.classList.add('on'); setTimeout(()=>p.classList.remove('on'),300); }
        function show(){ active=false; input=[]; seq.push(pads[Math.floor(Math.random()*pads.length)]); (async()=>{ for(const p of seq){ flash(p); await new Promise(r=>setTimeout(r,460)); } active=true; })(); }
        pads.forEach(p=>p.onclick=()=>{ if(!active) return; flash(p); input.push(p); if(p!==seq[input.length-1]){ box.innerHTML='<h3 style="text-align:center">Try again!</h3>'; }
          else if(input.length===seq.length){ level++; if(level>5){ awardCoins(2); box.innerHTML='<h3 style="text-align:center">You win!</h3>'; } else setTimeout(show,500); } }); show(); }
      else if(id==='memory'){ const nums=[1,1,2,2,3,3,4,4,5,5,6,6].sort(()=>Math.random()-.5); const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(4,1fr)'; grid.style.gap='8px'; box.appendChild(grid);
        let last=null,matched=0; nums.forEach(n=>{ const c=document.createElement('button'); c.textContent='?'; c.style.padding='18px 0'; c.style.borderRadius='10px'; c.dataset.v=n;
          c.onclick=()=>{ if(c.disabled) return; c.textContent=n; c.disabled=true; if(!last){ last=c; } else { if(last.dataset.v===c.dataset.v){ matched+=2; if(matched===nums.length){ awardCoins(2); box.innerHTML='<h3 style="text-align:center">All matched!</h3>'; } last=null; }
            else { const a=last; setTimeout(()=>{ a.textContent='?'; a.disabled=false; c.textContent='?'; c.disabled=false; last=null; },650); } } }; grid.appendChild(c); }); }
      else if(id==='whack'){ const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(4,1fr)'; grid.style.gap='10px'; box.appendChild(grid);
        let score=0,time=20; const cells=[]; for(let i=0;i<12;i++){ const b=document.createElement('button'); b.style.height='60px'; b.style.borderRadius='10px'; b.textContent=''; b.onclick=()=>{ if(b.classList.contains('on')){ score++; b.classList.remove('on'); b.textContent=''; } }; grid.appendChild(b); cells.push(b); }
        const timer=setInterval(()=>{ if(--time<=0){ clearInterval(timer); clearInterval(spawn); awardCoins(1+Math.floor(score/5)); box.innerHTML='<h3 style="text-align:center">Whacks '+score+'</h3>'; } },1000);
        const spawn=setInterval(()=>{ cells.forEach(c=>{c.classList.remove('on'); c.textContent='';}); const b=cells[Math.floor(Math.random()*cells.length)]; b.classList.add('on'); b.textContent='🙂'; },720); }
      else if(id==='catch'){ const area=document.createElement('div'); area.style.position='relative'; area.style.height='300px'; area.style.background='rgba(255,255,255,.04)'; area.style.borderRadius='12px'; box.appendChild(area);
        const basket=document.createElement('div'); basket.className='basket'; area.appendChild(basket); let x=area.clientWidth/2, speed=6, score=0, time=20; function setX(){ basket.style.left=x+'px'; }
        function spawn(){ const s=document.createElement('div'); s.style.position='absolute'; s.style.width='14px'; s.style.height='14px'; s.style.borderRadius='50%'; s.style.background='#ffd54f'; s.style.left=(Math.random()*(area.clientWidth-14))+'px'; s.style.top='-10px'; area.appendChild(s);
          const fall=setInterval(()=>{ s.style.top=(s.offsetTop+4)+'px'; const by=basket.getBoundingClientRect(), sy=s.getBoundingClientRect(); if(sy.bottom>by.top && sy.left<by.right && sy.right>by.left){ score++; s.remove(); clearInterval(fall); }
            if(s.offsetTop>area.clientHeight) { s.remove(); clearInterval(fall); } },16); }
        const key=(e)=>{ if(e.key==='ArrowLeft') x-=speed; if(e.key==='ArrowRight') x+=speed; setX(); }; document.addEventListener('keydown', key);
        const sp=setInterval(spawn,720); const t=setInterval(()=>{ if(--time<=0){ clearInterval(sp); clearInterval(t); document.removeEventListener('keydown',key); awardCoins(1+Math.floor(score/5)); box.innerHTML='<h3 style="text-align:center">Stars '+score+'</h3>'; } },1000); setX(); }
      else if(id==='shapes'){ const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; box.appendChild(row);
        const shapes=['▲','●','■','◆']; let score=0, rounds=8;
        function next(){ if(rounds--<=0){ awardCoins(1+Math.floor(score/3)); box.innerHTML='<h3 style="text-align:center">Nice taps: '+score+'</h3>'; return; }
          row.innerHTML=''; const want=shapes[Math.floor(Math.random()*shapes.length)]; const target=document.createElement('div'); target.style.textAlign='center'; target.style.margin='6px 0 12px'; target.innerHTML='Tap all: <b>'+want+'</b>'; box.appendChild(target);
          const pool=[...shapes,...shapes,...shapes].sort(()=>Math.random()-.5).slice(0,10);
          pool.forEach(s=>{ const b=document.createElement('button'); b.textContent=s; b.style.padding='10px 14px'; b.style.borderRadius='10px'; b.onclick=()=>{ if(s===want){ score++; b.disabled=true; b.style.opacity=.5; } }; row.appendChild(b); });
          setTimeout(next,1800);
        } next(); }
    }

    // Toddler Pet page
    function ensurePet(){
      const tpl=document.querySelector('#tpl-pet'); const v=$V(); if(!tpl||!v) return;
      v.innerHTML=''; v.appendChild(tpl.content.cloneNode(true));
      const state=LS.get('sb_state',DEF); const coinsEl=document.getElementById('todCoins'); if(coinsEl) coinsEl.textContent=state.toddlerCoins||0;
      document.getElementById('earnHint')?.addEventListener('click',()=>alert('Play Minigames to earn toddler coins.'));

      const notice=document.getElementById('petNotice');
      if(!state.toddler){ notice.classList.remove('hidden'); return; } else { notice.classList.add('hidden'); }

      const stage=document.getElementById('petStage'); stage.innerHTML='';
      const birb=new Image(); birb.src='assets/birb.png'; birb.alt='Birb'; birb.className='birb'; birb.onerror=()=>{birb.src='assets/icon.svg'}; stage.appendChild(birb);

      // Owned accessories list (equip/unequip)
      if(!state.pet) state.pet={acc:[],owned:[]}; if(!state.pet.acc) state.pet.acc=[]; if(!state.pet.owned) state.pet.owned=[];
      const ACC=['cap','bow','glasses','scarf','boots'];
      const list=document.getElementById('accList'); list.innerHTML='';
      ACC.forEach(id=>{
        if(!state.pet.owned.includes(id)) return; // show only owned here
        const lab=document.createElement('label'); lab.style.display='flex'; lab.style.gap='8px';
        const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=state.pet.acc.includes(id);
        chk.onchange=()=>{ const i=state.pet.acc.indexOf(id); if(chk.checked&&i<0) state.pet.acc.push(id); if(!chk.checked&&i>=0) state.pet.acc.splice(i,1); LS.set('sb_state',state); };
        lab.appendChild(chk); lab.appendChild(document.createTextNode(id));
        list.appendChild(lab);
      });

      // Shop (buy buttons)
      const costs={cap:1,bow:1,glasses:2,scarf:2,boots:3};
      document.querySelectorAll('[data-buy]').forEach(btn=>{
        const id=btn.getAttribute('data-buy'); const update=()=>{ btn.disabled=state.pet.owned.includes(id); btn.textContent = state.pet.owned.includes(id) ? 'Owned' : 'Buy'; };
        update();
        btn.addEventListener('click',()=>{
          const cost=costs[id];
          const have=state.toddlerCoins||0;
          if(have<cost){ alert('Not enough toddler coins.'); return; }
          state.toddlerCoins = have - cost;
          if(!state.pet.owned.includes(id)) state.pet.owned.push(id);
          LS.set('sb_state',state);
          const coinsEl=document.getElementById('todCoins'); if(coinsEl) coinsEl.textContent=state.toddlerCoins;
          ensurePet(); // rerender to refresh owned list
        });
      });
    }

  })();
  </script>
</body>
</html>
